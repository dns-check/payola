<div class="well payment-well" style="margin-bottom: 0px;">
  <%= form_tag payola.buy_path(product_class: sale.product.product_class, permalink: permalink), :class => '', :id => 'payment-form' do %>
  <% if coupon %>
    <input type="hidden" name="coupon_code" value="<%= coupon.code %>" />
  <% end %>
  <div class="row">
    <label class="control-label" for="email">Email Address <span class="label pull-right" style="margin-right: 8px">Secure <img src="<%= asset_path('lock.png') %>" style="height: 13px"></span></label>
    <input autofocus="true" type="email" name="email" id="email" placeholder="you@example.com" class="payment-input"/>
  </div>
  <div class="row">
    <label class="control-label" for="card-element">Card Details <span class="pull-right" style="margin-right: 8px"><img src="<%= asset_path('visa.png') %>" style="height: 15px;"><img src="<%= asset_path('mastercard.png') %>" style="height: 15px;"><img src="<%= asset_path('amex.png') %>" style="height: 15px;"><img src="<%= asset_path('discover.png') %>" style="height: 15px;"></span></label>
    <div id="card-element" class="payment-input"></div>
    <div id="card-errors" role="alert" style="color: #dc3545; margin-top: 8px; font-size: 14px;"></div>
  </div>
  <div class="row" style="margin-top: 20px">
    <div class="price" style="margin-top: 20px; float: left"><%= price %></div>
    <div style="float: right; margin-right: 8px;text-align:center">
      <div class="btn btn-success btn-large" disabled="disabled" style="display: none; width: 70px; height: 20px;" id="spinner-button"><img src="<%= asset_path('green_spinner_2.gif') %>" style="height: 15px;"></div>
      <button type="submit" class="btn btn-success btn-large" id="pay-button">Pay Now</button><br>
    </div>
  </div>
  <% end %>
</div>
<div class="payment-well" style="margin-top: 0px; margin-bottom: 0px;">
  <div class="row">
    <div id="powered-by-stripe" style="<%= sale.errors.any? ? 'display: none;' : '' %> margin-left: auto; margin-right: auto; text-align: center; margin-top: 15px;">
      <img src="<%= asset_path('powered_by_stripe.png') %>">
    </div>
    <div id="payment-errors" class="alert payment-alert" style="<%= sale.errors.any? ? '' : 'display: none;' %> margin-bottom: 0px;">
      <% sale.errors.full_messages.each do |msg| %>
        <span><%= msg %></span>
      <% end %>
    </div>
  </div>
</div>
<script type="text/javascript" src="https://js.stripe.com/v3/"></script>
<script type="text/javascript">
  $(function(){

    var stripe = Stripe('<%= stripe_key %>');
    window.payolaStripe = stripe;
    var cardElement = PayolaStripe.createCardElement('#card-element', null, '#card-errors');

    $('#payment-form').submit(function(event) {
      var form = $(this);
      form.find('button').prop('disabled', true);

      stripe.createToken(cardElement).then(function(result) {
        if (result.error) {
          showError(result.error.message);
        } else {
          var token = result.token.id;
          form.append($('<input type="hidden" name="stripeToken">').val(token));
          $.ajax({
            type: "POST",
            url: "<%= payola.buy_url(product_class: sale.product.product_class, permalink: sale.product.permalink) %>",
            data: $('#payment-form').serialize(),
            success: function(data) { poll(data.guid, 60) },
            error: function(data) { showError(jQuery.parseJSON(data.responseText).error) }
          });
        }
      });

      $('#pay-button').hide();
      $('#spinner-button').show();
      $('#pay-button').prop('disabled', false);
      return false;
    });

    function showError(error) {
      var form = $('#payment-form');
      $('#payment-errors').html(error);
      $('#payment-errors').show();
      $('#pay-button').show();
      $('#powered-by-stripe').hide();
      $('#spinner-button').hide();
    }

    function poll(guid, num_retries_left) {
      if (num_retries_left == 0) {
        showError("This seems to be taking too long. Email <a href=\"mailto:<%= Payola.support_email %>\"><%= Payola.support_email %></a> and reference transaction <strong>" + guid + "</strong>.");
        return;
      }
      $.get("/payola/status/" + guid, function(data) {
        if (data.status === "finished") {
          window.location = "/payola/confirm/" + guid;
        } else if (data.status === "errored") {
          showError(data.error)
        } else {
          setTimeout(function() { poll(guid, num_retries_left - 1) }, 500);
        }
      });
    }
  });
</script>
