<%
  button_text = local_assigns.fetch :button_text, "Subscribe Now"
  plan_class = plan.plan_class
  plan_id = plan.id
  quantity = local_assigns.fetch :quantity, 1
  coupon = local_assigns.fetch :coupon, nil
  price = local_assigns.fetch :price, plan.amount * quantity
  name = local_assigns.fetch :name, plan.name
  custom_fields = local_assigns.fetch :custom_fields, nil
  form_url = local_assigns.fetch :form_url, payola.subscribe_path(plan_class: plan_class, plan_id: plan_id)
  stripe_customer_id = local_assigns.fetch :stripe_customer_id, nil

  subscription = Payola::Subscription.new(plan: plan)

  form_id = "payola-subscription-checkout-form-#{plan_class}-#{plan_id}"

  currency = plan.respond_to?(:currency) ? plan.currency : Payola.default_currency
  tax_percent = local_assigns.fetch(:tax_percent, Payola.default_tax_percent).to_f.round(2)

  error_div_id = local_assigns.fetch :error_div_id, ''
  if error_div_id.present?
    show_default_error_div = false
  else
    error_div_id = "#{form_id}-errors"
    show_default_error_div = true
  end

  html_hash = {
    id: form_id,
    class: 'payola-subscription-checkout-form',
    'data-payola-base-path' => main_app.payola_path,
    'data-payola-plan-type' => plan_class,
    'data-payola-plan-id' => plan_id,
    'data-payola-quantity' => quantity,
    'data-payola-tax-percent' => tax_percent,
    'data-payola-currency' => currency,
    'data-payola-error-selector' => "##{error_div_id}"
  }

  html_hash['data-payola-coupon'] = coupon if coupon
  html_hash['data-stripe-customer-id'] = stripe_customer_id if stripe_customer_id
  html_hash['data-payola-signed-custom-fields'] = subscription.verifier.generate(custom_fields) if custom_fields
%>

<script type="text/javascript" src="https://js.stripe.com/v3/"></script>

<%= form_tag form_url, html_hash do %>
  <%= render 'payola/transactions/checkout_form_fields', form_id: form_id, button_text: button_text, error_div_id: error_div_id, show_default_error_div: show_default_error_div %>
<% end %>

<script type="text/javascript">
(function() {
  var checkout = PayolaCheckoutForm.init({
    formId: '<%= form_id %>',
    publishableKey: '<%= Payola.publishable_key_for_sale(subscription) %>',
    pollEndpoint: function(basePath, guid) {
      return basePath + '/subscription_status/' + guid;
    },
    onSubmit: function(token, form) {
      var email = form.querySelector("[data-payola='email']").value;
      var planType = form.getAttribute('data-payola-plan-type');
      var planId = form.getAttribute('data-payola-plan-id');
      var quantity = form.getAttribute('data-payola-quantity');
      var taxPercent = form.getAttribute('data-payola-tax-percent');
      var currency = form.getAttribute('data-payola-currency');
      var coupon = form.getAttribute('data-payola-coupon');
      var stripeCustomerId = form.getAttribute('data-stripe-customer-id');
      var signedCustomFields = form.getAttribute('data-payola-signed-custom-fields');

      var data = new FormData();
      data.append('stripeToken', token.id);
      data.append('stripeEmail', email);
      data.append('plan_type', planType);
      data.append('plan_id', planId);
      data.append('quantity', quantity || '1');
      data.append('tax_percent', taxPercent || '0');
      data.append('currency', currency || '');
      if (coupon) data.append('coupon', coupon);
      if (stripeCustomerId) data.append('stripe_customer_id', stripeCustomerId);
      if (signedCustomFields) data.append('signed_custom_fields', signedCustomFields);

      PayolaCheckoutForm.submitAndPoll(form, form.action, data, checkout.poll);
    },
    onPollSuccess: function(data, guid, basePath, form, retriesLeft) {
      // Handle SCA (3D Secure) authentication if needed
      if (!PayolaStripeSCA.handlePollResponse(data, {
        onActive: function() {
          window.location = basePath + '/confirm_subscription/' + guid;
        },
        onError: function(error) {
          PayolaCheckoutForm.showError(form, error);
        },
        onScaSuccess: function() {
          // After successful SCA, restart polling
          setTimeout(function() { checkout.poll(guid, 60); }, 1000);
        }
      })) {
        // Continue polling
        setTimeout(function() { checkout.poll(guid, retriesLeft - 1); }, 500);
      }
    }
  });
})();
</script>
