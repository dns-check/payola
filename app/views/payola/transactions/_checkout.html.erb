<%
  button_text = local_assigns.fetch :button_text, "Pay Now"
  product_class = sellable.product_class
  product_permalink = sellable.permalink
  price = local_assigns.fetch :price, sellable.price
  name = local_assigns.fetch :name, sellable.name
  custom_fields = local_assigns.fetch :custom_fields, nil
  stripe_customer_id = local_assigns.fetch :stripe_customer_id, nil

  sale = Payola::Sale.new(product: sellable)

  form_id = "payola-checkout-form-#{product_class}-#{product_permalink}"

  currency = sellable.respond_to?(:currency) ? sellable.currency : Payola.default_currency

  error_div_id = local_assigns.fetch :error_div_id, ''
  if error_div_id.present?
    show_default_error_div = false
  else
    error_div_id = "#{form_id}-errors"
    show_default_error_div = true
  end

  html_hash = {
    id: form_id,
    class: 'payola-checkout-form',
    'data-payola-base-path' => main_app.payola_path,
    'data-payola-product' => product_class,
    'data-payola-permalink' => product_permalink,
    'data-payola-currency' => currency,
    'data-payola-error-selector' => "##{error_div_id}"
  }

  html_hash['data-stripe-customer-id'] = stripe_customer_id if stripe_customer_id
  html_hash['data-payola-signed-custom-fields'] = sale.verifier.generate(custom_fields) if custom_fields
%>

<script type="text/javascript" src="https://js.stripe.com/v3/"></script>

<%= form_tag payola.buy_path(product_class: product_class, permalink: product_permalink), html_hash do %>
  <%= render 'payola/transactions/checkout_form_fields', form_id: form_id, button_text: button_text, error_div_id: error_div_id, show_default_error_div: show_default_error_div %>
<% end %>

<script type="text/javascript">
(function() {
  var checkout = PayolaCheckoutForm.init({
    formId: '<%= form_id %>',
    publishableKey: '<%= Payola.publishable_key_for_sale(sale) %>',
    pollEndpoint: function(basePath, guid) {
      return basePath + '/status/' + guid;
    },
    onSubmit: function(token, form) {
      var email = form.querySelector("[data-payola='email']").value;
      var basePath = form.getAttribute('data-payola-base-path');
      var product = form.getAttribute('data-payola-product');
      var permalink = form.getAttribute('data-payola-permalink');
      var currency = form.getAttribute('data-payola-currency');
      var stripeCustomerId = form.getAttribute('data-stripe-customer-id');
      var signedCustomFields = form.getAttribute('data-payola-signed-custom-fields');

      var data = new FormData();
      data.append('stripeToken', token.id);
      data.append('stripeEmail', email);
      data.append('currency', currency || '');
      if (stripeCustomerId) data.append('stripe_customer_id', stripeCustomerId);
      if (signedCustomFields) data.append('signed_custom_fields', signedCustomFields);

      PayolaCheckoutForm.submitAndPoll(form, basePath + '/buy/' + product + '/' + permalink, data, checkout.poll);
    },
    onPollSuccess: function(data, guid, basePath, form, retriesLeft) {
      if (data.status === 'finished') {
        window.location = basePath + '/confirm/' + guid;
      } else if (data.status === 'errored') {
        PayolaCheckoutForm.showError(form, data.error);
      } else {
        setTimeout(function() { checkout.poll(guid, retriesLeft - 1); }, 500);
      }
    }
  });
})();
</script>
